<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>EduTrack | Premium Attendance & Marks Management</title>
    <!-- KILL any stale service workers (e.g. from antygravity PWA) -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister();
                    console.log('EduTrack: Cleared stale service worker:', registration.scope);
                }
            });
            // Also clear all caches
            if ('caches' in window) {
                caches.keys().then(function (cacheNames) {
                    cacheNames.forEach(function (cacheName) {
                        caches.delete(cacheName);
                        console.log('EduTrack: Cleared cache:', cacheName);
                    });
                });
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Session guard ‚Äî redirect to login if not authenticated
        (function () {
            const session = sessionStorage.getItem('edutrack_user');
            if (!session) { window.location.href = './login.html'; return; }
            try {
                const u = JSON.parse(session);
                if (!u.loggedIn) window.location.href = './login.html';
            } catch (e) { window.location.href = './login.html'; }
        })();
    </script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">ET</div>
                <h1>EduTrack</h1>
            </div>
            <nav>
                <ul>
                    <li class="active" data-tab="dashboard">
                        <span class="icon">üìä</span> Dashboard
                    </li>
                    <li data-tab="attendance">
                        <span class="icon">üìÖ</span> Attendance
                    </li>
                    <li data-tab="students">
                        <span class="icon">üë•</span> Students
                    </li>
                    <li data-tab="jarvis">
                        <span class="icon">‚ö°</span> JARVIS Dispatcher
                    </li>
                    <li data-tab="activity" class="admin-only">
                        <span class="icon">üì°</span> Activity Monitor
                    </li>
                    <li data-tab="users" class="admin-only">
                        <span class="icon">üîë</span> Manage Users
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User">
                    <div class="user-info">
                        <p class="name" id="user-display-name">User</p>
                        <p class="role" id="user-display-role">Role</p>
                    </div>
                </div>
                <button onclick="doLogout()" style="width:100%; margin-top:12px; padding:10px; background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.3); color:#ef4444; border-radius:8px; cursor:pointer; font-family:'Outfit',sans-serif; font-size:0.85rem; font-weight:600;">üö™ Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <header>
                <div class="header-search">
                    <span class="search-icon">üîç</span>
                    <input type="text" placeholder="Search students, records...">
                </div>
                <div class="header-actions">
                    <button class="btn-icon">üîî</button>
                    <button class="btn-primary" id="mark-attendance-btn">+ Mark Attendance</button>
                </div>
            </header>

            <!-- Dynamic Tab Content -->
            <div id="tab-content">
                <!-- Dashboard Tab (Default) -->
                <section id="dashboard-tab" class="tab-pane active">
                    <div class="welcome-banner">
                        <div class="welcome-text">
                            <h2>Welcome back, Admin! üëã</h2>
                            <p>Here's what's happening in your department today.</p>
                        </div>
                        <div class="date-display">
                            <span id="current-date">October 24, 2023</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon attendance">üë•</div>
                            <div class="stat-details">
                                <p class="label">Total Students</p>
                                <h3 id="total-students">1,240</h3>
                                <p class="trend up"><span>‚Üë</span> 3 departments active</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon present">‚úÖ</div>
                            <div class="stat-details">
                                <p class="label">Avg. Attendance</p>
                                <h3 id="avg-attendance-pct">92%</h3>
                                <p class="trend up"><span>‚Üë</span> Higher than last week</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon absent">‚ö†Ô∏è</div>
                            <div class="stat-details">
                                <p class="label">Critical Low Attn.</p>
                                <h3 id="low-att-count">24</h3>
                                <p class="danger-text">Needs attention</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon marks">üîî</div>
                            <div class="stat-details">
                                <p class="label">Pending Alerts</p>
                                <h3 id="pending-alerts">12</h3>
                                <p class="trend">Ready to send</p>
                            </div>
                        </div>
                    </div>

                    <div class="main-grid-row">
                        <div class="card attendance-chart">
                            <div class="card-header">
                                <h3>Performance Analytics</h3>
                                <div class="badge-group">
                                    <span class="badge active">CSE</span>
                                    <span class="badge">ECE</span>
                                    <span class="badge">MECH</span>
                                </div>
                            </div>
                            <div class="chart-container-mock">
                                <div class="analytics-bars">
                                    <div class="bar-item">
                                        <div class="bar-fill" style="height: 85%"></div><span>Unit 1</span>
                                    </div>
                                    <div class="bar-item">
                                        <div class="bar-fill" style="height: 70%"></div><span>Unit 2</span>
                                    </div>
                                    <div class="bar-item">
                                        <div class="bar-fill" style="height: 92%"></div><span>Model</span>
                                    </div>
                                    <div class="bar-item">
                                        <div class="bar-fill" style="height: 65%"></div><span>Lab</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card announcements-card">
                            <div class="card-header">
                                <h3>Campus Announcements</h3>
                            </div>
                            <div class="announcement-list">
                                <div class="announcement-item">
                                    <div class="ann-date">FEB 18</div>
                                    <div class="ann-content">
                                        <p class="ann-title">Semester Exam Schedule Out</p>
                                        <p class="ann-desc">Final dates for internal assessments are updated.</p>
                                    </div>
                                </div>
                                <div class="announcement-item">
                                    <div class="ann-date">FEB 15</div>
                                    <div class="ann-content">
                                        <p class="ann-title">HOD Meeting @ 2PM</p>
                                        <p class="ann-desc">Discussion on department placement stats.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Attendance Tab -->
                <section id="attendance-tab" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mark Daily Attendance</h3>
                            <div class="filters">
                                <select id="dept-filter">
                                    <option>Computer Science</option>
                                    <option>Electronics</option>
                                </select>
                                <input type="date" value="2023-10-24">
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Students Tab -->
                <section id="students-tab" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3>Student Directory</h3>
                            <button class="btn-primary" id="add-student-btn">+ Add Student</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Parent Contact</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="marks-tab" class="tab-pane">
                    <div class="marks-split-view">
                        <div class="card marks-entry-card">
                            <div class="card-header">
                                <h3>Marks Dispatch Center</h3>
                                <div class="header-actions">
                                    <button class="btn-secondary" id="import-excel-btn">üì• Import Sheet</button>
                                    <input type="file" id="excel-file-input" hidden accept=".xlsx, .xls">
                                </div>
                            </div>
                            <div class="marks-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Target Student</label>
                                        <select id="marks-student-select">
                                            <option>Select from record...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Academic Subject</label>
                                        <input type="text" id="marks-subject" placeholder="e.g. Data Structures">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Assessment Type</label>
                                        <input type="text" id="marks-exam" placeholder="e.g. Internal-I">
                                    </div>
                                    <div class="form-group">
                                        <label>Performance Score</label>
                                        <input type="number" id="marks-value" placeholder="Max 100">
                                    </div>
                                </div>
                                <div class="action-footer">
                                    <button id="preview-msg-btn" class="btn-secondary">üëÅÔ∏è Preview Message</button>
                                    <button id="save-marks-btn" class="btn-primary">üöÄ Send via JARVIS</button>
                                </div>
                            </div>
                        </div>

                        <div class="card message-preview-card">
                            <div class="card-header">
                                <h3>WhatsApp Preview</h3>
                            </div>
                            <div class="whatsapp-bubble">
                                <div class="bubble-header">EduTrack Official</div>
                                <div class="bubble-body" id="whatsapp-preview-text">
                                    Select a student and enter marks to generate the official automated message
                                    preview.
                                </div>
                                <div class="bubble-footer">
                                    <span id="bubble-time">14:45</span>
                                    <span class="ticks">‚úì‚úì</span>
                                </div>
                            </div>
                            <p class="hint-text">JARVIS protocol will automatically format this for the registered
                                parent mobile number.</p>
                        </div>
                    </div>

                    <!-- New Bulk Import Preview Section -->
                    <div class="card bulk-preview-card" id="bulk-preview-section"
                        style="margin-top: 24px; display: none;">
                        <div class="card-header">
                            <h3>Excel Batch Processing</h3>
                            <div class="header-actions">
                                <button class="btn-primary" id="dispatch-all-btn">üöÄ Dispatch All Records</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Subject</th>
                                        <th>Exam</th>
                                        <th>Score</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="bulk-marks-body">
                                    <!-- Populated by Excel Import -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- JARVIS Tab -->
                <section id="jarvis-tab" class="tab-pane">
                    <iframe src="/JARVIS_RMKCET.html" style="width:100%; height:calc(100vh - 80px); border:none; border-radius:12px;"></iframe>
                </section>

                <!-- Notifications Tab -->
                <section id="notifications-tab" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3>WhatsApp Notification Logs</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Recipient</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Activity Monitor Tab (Admin Only) -->
                <section id="activity-tab" class="tab-pane admin-only">
                    <div class="card">
                        <div class="card-header">
                            <h3>üì° Session Activity Monitor</h3>
                            <div class="header-actions">
                                <button class="btn-secondary" onclick="clearAuditLogs()">üóëÔ∏è Clear Logs</button>
                                <button class="btn-primary" onclick="loadActivityLogs()">üîÑ Refresh</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height:500px; overflow-y:auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Login Time</th>
                                        <th>Logout Time</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Manage Users Tab (Admin Only) -->
                <section id="users-tab" class="tab-pane admin-only">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                        <div class="card">
                            <div class="card-header">
                                <h3>üîë Create Counsellor Account</h3>
                            </div>
                            <div style="padding:24px;">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="new-user-name" placeholder="e.g. Dr. Priya" style="width:100%;padding:10px 14px;background:rgba(0,0,0,0.3);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:'Outfit';font-size:0.9rem;outline:none;">
                                </div>
                                <div class="form-group" style="margin-top:16px;">
                                    <label>Username</label>
                                    <input type="text" id="new-user-username" placeholder="e.g. priya_counsel" style="width:100%;padding:10px 14px;background:rgba(0,0,0,0.3);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:'Outfit';font-size:0.9rem;outline:none;">
                                </div>
                                <div class="form-group" style="margin-top:16px;">
                                    <label>Password</label>
                                    <input type="text" id="new-user-password" placeholder="Min 6 characters" style="width:100%;padding:10px 14px;background:rgba(0,0,0,0.3);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:'Outfit';font-size:0.9rem;outline:none;">
                                </div>
                                <div id="create-user-msg" style="margin-top:12px;font-size:0.85rem;display:none;"></div>
                                <button class="btn-primary" onclick="createCounsellor()" style="margin-top:20px;width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;font-family:'Outfit';font-size:0.95rem;font-weight:600;">+ Create Counsellor Account</button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3>üë• Existing Counsellor Accounts</h3>
                                <button class="btn-primary" onclick="loadUsersList()" style="padding:6px 14px;">üîÑ Refresh</button>
                            </div>
                            <div class="table-container" style="max-height:400px; overflow-y:auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal for Marking Attendance -->
    <div id="attendance-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Select Student</h2>
            <div class="form-group">
                <label>Student Name</label>
                <select id="modal-student-select">
                    <option>Select Student...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <div class="radio-group">
                    <label><input type="radio" name="status" value="Present" checked> Present</label>
                    <label><input type="radio" name="status" value="Absent"> Absent</label>
                </div>
            </div>
            <div id="reason-field" class="form-group" style="display: none;">
                <label>Reason for Absence</label>
                <textarea id="absence-reason" placeholder="Optional reason..."></textarea>
            </div>
            <button id="save-attendance-btn" class="btn-primary full-width">Save & Notify Parent</button>
        </div>
    </div>

    <script type="module" src="./main.js"></script>
    <script>
        // ‚îÄ‚îÄ Audit Logging Helpers ‚îÄ‚îÄ
        function addAuditLog(entry) {
            const logs = JSON.parse(localStorage.getItem('edutrack_audit') || '[]');
            logs.push(entry);
            if (logs.length > 200) logs.splice(0, logs.length - 200);
            localStorage.setItem('edutrack_audit', JSON.stringify(logs));
        }

        // ‚îÄ‚îÄ Logout with audit ‚îÄ‚îÄ
        function recordLogout() {
            const session = sessionStorage.getItem('edutrack_user');
            if (!session) return;
            try {
                const user = JSON.parse(session);
                // Prevent duplicate logout entries for same session
                const logs = JSON.parse(localStorage.getItem('edutrack_audit') || '[]');
                const alreadyLogged = logs.some(l => l.action === 'LOGOUT' && l.loginTime === user.loginTime && l.username === user.username);
                if (alreadyLogged) return;
                addAuditLog({
                    action: 'LOGOUT',
                    user: user.name,
                    username: user.username,
                    role: user.role,
                    loginTime: user.loginTime,
                    logoutTime: new Date().toISOString()
                });
            } catch(e) {}
        }

        function doLogout() {
            recordLogout();
            sessionStorage.removeItem('edutrack_user');
            window.location.href = './login.html';
        }

        // Auto-record logout when tab/browser is closed or page is refreshed
        window.addEventListener('beforeunload', () => { recordLogout(); removeHeartbeat(); });
        window.addEventListener('pagehide', () => { recordLogout(); removeHeartbeat(); });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ WATCHDOG: Activity Tracking & Heartbeat System ‚îÄ‚îÄ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const INACTIVE_THRESHOLD = 5 * 60 * 1000;   // 5 minutes
        const HEARTBEAT_INTERVAL = 15 * 1000;        // ping every 15 seconds
        const WATCHDOG_INTERVAL  = 30 * 1000;        // check every 30 seconds

        let lastUserActivity = Date.now();
        let isMarkedInactive = false;

        // Track real user interactions
        ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart', 'click'].forEach(evt => {
            document.addEventListener(evt, () => {
                lastUserActivity = Date.now();
                // If user was inactive and becomes active again, re-activate
                if (isMarkedInactive) {
                    isMarkedInactive = false;
                    sendHeartbeat(true);  // force immediate heartbeat
                    const session = sessionStorage.getItem('edutrack_user');
                    if (session) {
                        try {
                            const user = JSON.parse(session);
                            addAuditLog({
                                action: 'REACTIVATED',
                                user: user.name,
                                username: user.username,
                                role: user.role,
                                loginTime: user.loginTime,
                                time: new Date().toISOString()
                            });
                        } catch(e) {}
                    }
                }
            }, { passive: true });
        });

        // Get heartbeat key for current session
        function getHeartbeatKey() {
            const session = sessionStorage.getItem('edutrack_user');
            if (!session) return null;
            try {
                const user = JSON.parse(session);
                return 'edutrack_hb_' + user.username + '_' + encodeURIComponent(user.loginTime);
            } catch(e) { return null; }
        }

        // Send heartbeat to localStorage (visible to admin's Activity Monitor)
        function sendHeartbeat(force) {
            const session = sessionStorage.getItem('edutrack_user');
            if (!session) return;
            const key = getHeartbeatKey();
            if (!key) return;

            const now = Date.now();
            const idleMs = now - lastUserActivity;
            const isActive = idleMs < INACTIVE_THRESHOLD;

            // If idle too long, flag as inactive
            if (!isActive && !isMarkedInactive) {
                isMarkedInactive = true;
                try {
                    const user = JSON.parse(session);
                    addAuditLog({
                        action: 'INACTIVE',
                        user: user.name,
                        username: user.username,
                        role: user.role,
                        loginTime: user.loginTime,
                        time: new Date().toISOString()
                    });
                } catch(e) {}
            }

            try {
                const user = JSON.parse(session);
                const hb = {
                    username: user.username,
                    user: user.name,
                    role: user.role,
                    loginTime: user.loginTime,
                    lastActive: new Date(lastUserActivity).toISOString(),
                    lastPing: new Date().toISOString(),
                    status: isActive ? 'active' : 'inactive'
                };
                localStorage.setItem(key, JSON.stringify(hb));
            } catch(e) {}
        }

        // Remove heartbeat on logout/close
        function removeHeartbeat() {
            const key = getHeartbeatKey();
            if (key) localStorage.removeItem(key);
        }

        // Start heartbeat
        sendHeartbeat(true);
        setInterval(() => sendHeartbeat(false), HEARTBEAT_INTERVAL);

        // ‚îÄ‚îÄ Get all live heartbeats ‚îÄ‚îÄ
        function getAllHeartbeats() {
            const heartbeats = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('edutrack_hb_')) {
                    try {
                        heartbeats[key] = JSON.parse(localStorage.getItem(key));
                    } catch(e) {}
                }
            }
            return heartbeats;
        }

        // ‚îÄ‚îÄ Load Activity Logs ‚îÄ‚îÄ
        function loadActivityLogs() {
            const tbody = document.getElementById('activity-table-body');
            if (!tbody) return;
            const logs = JSON.parse(localStorage.getItem('edutrack_audit') || '[]');
            const heartbeats = getAllHeartbeats();

            // Build a lookup: username_loginTime ‚Üí heartbeat
            const hbLookup = {};
            Object.values(heartbeats).forEach(hb => {
                hbLookup[hb.username + '_' + hb.loginTime] = hb;
            });

            // Pair LOGIN/LOGOUT entries
            const sessions = [];
            const loginMap = {};
            logs.forEach(log => {
                if (log.action === 'LOGIN') {
                    loginMap[log.username + '_' + log.time] = log;
                    sessions.push({ login: log, logout: null });
                } else if (log.action === 'LOGOUT') {
                    // Find matching login
                    const match = sessions.find(s => s.login.username === log.username && s.login.time === log.loginTime && !s.logout);
                    if (match) match.logout = log;
                    else sessions.push({ login: { user: log.user, username: log.username, role: log.role, time: log.loginTime }, logout: log });
                }
            });

            // Reverse to show newest first
            sessions.reverse();

            tbody.innerHTML = sessions.map(s => {
                const loginTime = s.login.time ? new Date(s.login.time).toLocaleString() : '-';
                
                // Determine status using heartbeat data
                const hbKey = s.login.username + '_' + s.login.time;
                const hb = hbLookup[hbKey];
                let statusIcon, statusLabel, logoutDisplay;

                if (s.logout) {
                    // Session ended
                    statusIcon = 'üî¥';
                    statusLabel = 'Ended';
                    logoutDisplay = new Date(s.logout.logoutTime).toLocaleString();
                } else if (hb) {
                    // Live heartbeat exists ‚Äî check if active or inactive
                    const lastPing = new Date(hb.lastPing).getTime();
                    const lastActive = new Date(hb.lastActive).getTime();
                    const now = Date.now();
                    const pingAge = now - lastPing;
                    const idleTime = now - lastActive;

                    if (pingAge > 60000) {
                        // Heartbeat stale (>60s) ‚Äî tab probably closed without cleanup
                        statusIcon = '‚ö´';
                        statusLabel = 'Stale';
                        logoutDisplay = '<span style="color:#6b7280;">No signal</span>';
                    } else if (hb.status === 'inactive' || idleTime > INACTIVE_THRESHOLD) {
                        statusIcon = 'üü°';
                        statusLabel = 'Inactive';
                        const idleMins = Math.floor(idleTime / 60000);
                        logoutDisplay = `<span style="color:#f59e0b;">Idle ${idleMins}m</span>`;
                    } else {
                        statusIcon = 'üü¢';
                        statusLabel = 'Active';
                        logoutDisplay = '<span style="color:#22c55e;">Online Now</span>';
                    }
                } else {
                    // No heartbeat and no logout ‚Äî orphaned session
                    statusIcon = '‚ö´';
                    statusLabel = 'Unknown';
                    logoutDisplay = '<span style="color:#6b7280;">No data</span>';
                }

                let duration = '-';
                if (s.login.time) {
                    const start = new Date(s.login.time);
                    const end = s.logout ? new Date(s.logout.logoutTime) : new Date();
                    const diffMs = end - start;
                    const mins = Math.floor(diffMs / 60000);
                    const hrs = Math.floor(mins / 60);
                    const remMins = mins % 60;
                    duration = hrs > 0 ? `${hrs}h ${remMins}m` : `${remMins}m`;
                    if (mins < 1) duration = '<1m';
                }
                const roleBadge = s.login.role === 'admin'
                    ? '<span style="background:rgba(56,189,248,0.15);color:#38bdf8;padding:2px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">Admin</span>'
                    : '<span style="background:rgba(168,85,247,0.15);color:#a855f7;padding:2px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">Counsellor</span>';
                return `<tr>
                    <td>${statusIcon} ${statusLabel}</td>
                    <td><strong>${s.login.user || s.login.username}</strong></td>
                    <td>${roleBadge}</td>
                    <td>${loginTime}</td>
                    <td>${logoutDisplay}</td>
                    <td style="font-weight:600;">${duration}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-secondary);">No activity recorded yet</td></tr>';
        }

        function clearAuditLogs() {
            if (confirm('Clear all activity logs and heartbeat data?')) {
                localStorage.removeItem('edutrack_audit');
                // Clean up all heartbeat entries
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('edutrack_hb_')) keysToRemove.push(key);
                }
                keysToRemove.forEach(k => localStorage.removeItem(k));
                loadActivityLogs();
            }
        }

        // ‚îÄ‚îÄ Create Counsellor Account ‚îÄ‚îÄ
        function createCounsellor() {
            const name = document.getElementById('new-user-name').value.trim();
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value;
            const msgEl = document.getElementById('create-user-msg');

            if (!name || !username || !password) {
                msgEl.style.display = 'block';
                msgEl.style.color = '#ef4444';
                msgEl.textContent = 'All fields are required';
                return;
            }
            if (password.length < 6) {
                msgEl.style.display = 'block';
                msgEl.style.color = '#ef4444';
                msgEl.textContent = 'Password must be at least 6 characters';
                return;
            }

            const users = JSON.parse(localStorage.getItem('edutrack_users') || '{}');
            // Check duplicate username
            for (const key in users) {
                if (users[key].username === username) {
                    msgEl.style.display = 'block';
                    msgEl.style.color = '#ef4444';
                    msgEl.textContent = 'Username already exists';
                    return;
                }
            }

            const key = 'counsellor_' + Date.now();
            users[key] = {
                username: username,
                password: password,
                role: 'counsellor',
                name: name,
                title: 'Student Counsellor'
            };
            localStorage.setItem('edutrack_users', JSON.stringify(users));

            msgEl.style.display = 'block';
            msgEl.style.color = '#22c55e';
            msgEl.textContent = `‚úì Account created for ${name}`;
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
            loadUsersList();

            // Audit
            const session = sessionStorage.getItem('edutrack_user');
            if (session) {
                const admin = JSON.parse(session);
                addAuditLog({ action: 'CREATE_USER', user: admin.name, role: admin.role, target: name, targetUsername: username, time: new Date().toISOString() });
            }
        }

        // ‚îÄ‚îÄ Load Users List ‚îÄ‚îÄ
        function loadUsersList() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            const users = JSON.parse(localStorage.getItem('edutrack_users') || '{}');
            const counsellors = Object.entries(users).filter(([k, u]) => u.role === 'counsellor');

            tbody.innerHTML = counsellors.map(([key, u]) => `<tr>
                <td><strong>${u.name}</strong></td>
                <td style="font-family:monospace;">${u.username}</td>
                <td><span style="background:rgba(168,85,247,0.15);color:#a855f7;padding:2px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;">Counsellor</span></td>
                <td><button onclick="deleteUser('${key}')" style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'Outfit';font-size:0.8rem;">üóëÔ∏è Remove</button></td>
            </tr>`).join('') || '<tr><td colspan="4" style="text-align:center;padding:30px;color:var(--text-secondary);">No counsellor accounts yet</td></tr>';
        }

        function deleteUser(key) {
            if (!confirm('Remove this counsellor account?')) return;
            const users = JSON.parse(localStorage.getItem('edutrack_users') || '{}');
            const deleted = users[key];
            delete users[key];
            localStorage.setItem('edutrack_users', JSON.stringify(users));
            loadUsersList();
            if (deleted) {
                const session = sessionStorage.getItem('edutrack_user');
                if (session) {
                    const admin = JSON.parse(session);
                    addAuditLog({ action: 'DELETE_USER', user: admin.name, role: admin.role, target: deleted.name, time: new Date().toISOString() });
                }
            }
        }

        // ‚îÄ‚îÄ Role-based UI setup ‚îÄ‚îÄ
        (function() {
            const session = sessionStorage.getItem('edutrack_user');
            if (!session) return;
            try {
                const user = JSON.parse(session);
                // Set user info in sidebar
                const nameEl = document.getElementById('user-display-name');
                const roleEl = document.getElementById('user-display-role');
                if (nameEl) nameEl.textContent = user.name || 'User';
                if (roleEl) roleEl.textContent = user.title || 'Role';

                // Counsellor restrictions: hide admin-only tabs
                if (user.role === 'counsellor') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                    // Also hide marks tab
                    const marksTab = document.getElementById('marks-tab');
                    if (marksTab) marksTab.style.display = 'none';
                } else {
                    // Admin ‚Äî load activity & users
                    loadActivityLogs();
                    loadUsersList();

                    // Watchdog: auto-refresh Activity Monitor every 30s
                    setInterval(() => {
                        // Only refresh if activity tab is visible
                        const actTab = document.getElementById('activity-tab');
                        if (actTab && actTab.classList.contains('active')) {
                            loadActivityLogs();
                        }
                    }, WATCHDOG_INTERVAL);
                }
            } catch(e) {}
        })();
    </script>
</body>

</html>